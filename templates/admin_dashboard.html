{% extends 'base.html' %}
{% block title %}Admin Command Center{% endblock %}

{% block content %}
<h2 style="text-align:center; background:#d32f2f; color:white; padding:15px; margin:0;">
  EMERGENCY COMMAND CENTER
</h2>

<div id="map" style="width:100%; height:90vh;"></div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io();
  let map;
  let markers = {};

function initMap() {
  const romaniaCenter = { lat: 45.9432, lng: 24.9668 };

  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 6,
    center: romaniaCenter,
    mapTypeId: 'roadmap'
  });

  fetch('/api/alerts/active')
    .then(r => r.json())
    .then(alerts => {
      if (alerts.length === 0) {
        map.setCenter(romaniaCenter);
        map.setZoom(6);
      } else {
        alerts.forEach(addMarker);
        const latest = alerts[0];
        map.setCenter({ lat: latest.latitude, lng: latest.longitude });
        map.setZoom(13);
      }
    });
}

  function addMarker(alert) {
    if (!alert.latitude || !alert.longitude) return;

    const icon = alert.severity === 'critical' ? 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' :
                 alert.severity === 'high'     ? 'http://maps.google.com/mapfiles/ms/icons/orange-dot.png' :
                                                  'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png';

    const marker = new google.maps.Marker({
      position: { lat: alert.latitude, lng: alert.longitude },
      map: map,
      icon: icon,
      animation: google.maps.Animation.DROP
    });

    const infoContent = `
      <div style="max-width:300px; font-family:Arial;">
        <h3>Alert #${alert.alert_id}</h3>
        <p><strong>Type:</strong> ${alert.type?.toUpperCase() || 'N/A'}</p>
        <p><strong>Severity:</strong> <span style="color:${alert.severity==='critical'?'red':'orange'}; font-weight:bold;">
          ${alert.severity?.toUpperCase() || 'UNKNOWN'}
        </span></p>
        <p><strong>Description:</strong> ${alert.description || 'Panic button pressed'}</p>
        <p><strong>Reported by:</strong> ${alert.citizen_name || 'Anonymous'}</p>
        <p><strong>Time:</strong> ${new Date(alert.timestamp).toLocaleString()}</p>
        ${alert.status === 'reported' ? `
          <form action="/admin/assign/${alert.alert_id}" method="POST" style="margin-top:8px;">
            <select name="responder_id" required style="width:100%; padding:5px;">
              <option value="">— Select Responder —</option>
              ${window.responders?.map(r => 
                `<option value="${r.user_id}">${r.name} (${r.role})</option>`
              ).join('') || ''}
            </select>
            <button type="submit" style="background:#d32f2f; color:white; border:none; padding:8px; width:100%; margin-top:5px;">
              Assign Responder
            </button>
          </form>
        ` : `<p><strong>Status:</strong> <em>${(alert.status || 'unknown').replace('_', ' ')}</em></p>`}
      </div>
    `;

    const infoWindow = new google.maps.InfoWindow({ content: infoContent });
    marker.addListener('click', () => infoWindow.open(map, marker));
    markers[alert.alert_id] = { marker, infoWindow };
  }

  socket.on('new_alert', (alert) => {
    console.log("New alert:", alert);
    addMarker(alert);
    if (alert.severity === 'critical') {
      map.setCenter({ lat: alert.latitude, lng: alert.longitude });
      map.setZoom(16);
    }
  });

  socket.on('status_update', (data) => {
    console.log("Status updated:", data);
  });

  fetch('/admin/responders')
    .then(r => r.json())
    .then(data => window.responders = data)
    .catch(() => console.log("No responders loaded"));

  setInterval(() => socket.emit('ping'), 25000);
  socket.on('connect', () => console.log('SocketIO connected'));
  socket.on('disconnect', () => console.log('SocketIO disconnected'));
</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&callback=initMap">
</script>

{% endblock %}